---
title: "HW5"
author: "KurochkinaDN"
date: "2024-04-02"
output: html_document
---

Задание 1 (2 балла)
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

Задание 2 (2 балла)
Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

Задание 3 (6 балла)
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.
Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?



## Задание 1 (2 балла)
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли radius_mean и средней площади area_mean (а), среднего периметра perimeter_mean (б), средней симметричности symmetry_mean (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# импорт библиотек
library(dplyr)
# Загружаем библиотеку ggplot2
library(ggplot2)

```


```{r load, include=TRUE}
#загрузка файла
bc <- read.csv("/home/dasha/Desktop/МФТИ/биостатистика/asset-v1_SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv")

# проверка на пропущенные значения
which(is.na(bc)) # их нет

```

```{r}
# связь среднего радиуса опухоли radius_mean и средней площади area_mean (а)
model_area <- lm(radius_mean ~ area_mean, data = bc)
summary(model_area)

```

```{r}
# Модель б) связь среднего радиуса опухоли radius_mean и среднего периметра perimeter_mean (б)
model_perimeter <- lm(radius_mean ~ perimeter_mean, data = bc)
summary(model_perimeter)

```

```{r}
# Модель в) связь среднего радиуса опухоли radius_mean и средней симметричности symmetry_mean (в)
model_symmetry <- lm(radius_mean ~ symmetry_mean, data = bc)
summary(model_symmetry)

```


```{r}
# Создаем график для модели radius_mean ~ area_mean
ggplot(model_area, aes(x = radius_mean, y = area_mean)) +
    geom_point()+
  stat_smooth(method = "lm",
        col = "red",
        se = FALSE,
        size = 1)+
  labs(title = paste("график для модели  radius_mean ~ area_mean"),
       x = "средний радиус",
       y = "средняя площадь")


```
```{r}
# Создаем график для модели radius_mean ~ perimeter_mean
ggplot(model_perimeter, aes(x = radius_mean, y = perimeter_mean)) +
    geom_point()+
  stat_smooth(method = "lm",
        col = "red",
        se = FALSE,
        size = 1)+
  labs(title = paste("график для модели radius_mean ~ perimeter_mean"),
       x = "средний радиус",
       y = "средний периметр")


```
```{r}
# Создаем график для модели radius_mean ~ symmetry_mean
ggplot(model_symmetry, aes(x = radius_mean, y = symmetry_mean)) +
    geom_point()+
  stat_smooth(method = "lm",
        col = "red",
        se = FALSE,
        size = 1)+
  labs(title = paste("график для модели radius_mean ~ symmetry_mean"),
       x = "средний радиус",
       y = "средняя симметричность")


```
Вывод: На основании полученных графических данных можно сделать вывод что есть прямая линейная взаимосвязь между средним радиусом и средним периметром, и средней площадью. По мере увеличения сренего радиуса увеличивается средний периметр и средняя площадь.
Между средним радиусом и средней симметричностью визуально нет линейной взаимосвязи, линия регрессии практически параллельна оси  х.

Данные утверждения отражены в рассчетных значениях уравнения линейной регрессии:
для параметров: `radius_mean ~ area_mean` значение `Adjusted R-squared`:  0.9748 близко к 1,значит связь между параметрами сильная.
`p-value`: < 2.2e-16 => тк меньше 0.05 то нулевая гипотеза ложная (H0 = независимые переменные не объясняют динамику зависимой переменной) => верна альтернативная гипотеза. а значит, средняя площадь объясняет динамику среднего радиуса.
`t-value` = 148.3 что >2 => фактор area_mean является значимым для модели.

для параметров: `radius_mean ~ perimeter_mean` значение `Adjusted R-squared`:  0.9957 близко к 1,значит связь между параметрами сильная
`p-value`: < 2.2e-16 => тк меньше 0.05 то нулевая гипотеза ложная (H0 = независимые переменные не объясняют динамику зависимой переменной) => верна альтернативная гипотеза. а значит, среднй периметр объясняет динамику среднего радиуса.
`t-value` = 362.99 что >2 => фактор perimeter_mean является значимым для модели.

для параметров: `radius_mean ~ symmetry_mean` значение `Adjusted R-squared`: 0.0201  близко к 0,значит связь между параметрами слабая
`p-value`: 0.0004065 => тк меньше 0.05 то нулевая гипотеза ложная (H0 = независимые переменные не объясняют динамику зависимой переменной) => верна альтернативная гипотеза. а значит, средняя симметрия объясняет динамику среднего радиуса.
`t-value` = 3.55 что >2 => фактор symmetry_mean является значимым для модели, однако, в сравнении со значениями t-value для параметров area_mean и symmetry_mean, очевидно, значимость фактора symmetry_mean для модели ниже чем area_mean и symmetry_mean.



## Задание 2 (2 балла)

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
#Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0
bc['diagnosis'][bc['diagnosis'] == 'M'] <- 1
bc['diagnosis'][bc['diagnosis'] == 'B'] <- 0

bc <- bc %>%
    mutate(diagnosis = as.numeric(diagnosis),
          radius_mean = as.numeric(radius_mean), 
          area_mean = as.numeric(area_mean), 
          texture_mean = as.numeric(texture_mean))

```
Зависимая переменная в данном случае - diagnosis, независимые - radius_mean, area_mean, texture_mean
т.к. зависимая переменная принимает значения 0 и 1, подойдет бинарная логистическая регрессия.

```{r}

library(report)

# diagnosis~radius_mean
model1 <- glm(diagnosis~radius_mean, data = bc, family = binomial())


results1 <- report(model1)
print(results1)

# построение графика
ggplot(bc, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", se = FALSE, method.args = list(family=binomial)) +
  labs(title = "Вероятность злокачественной опухоли в зависимости от среднего радиуса",
       x = "Средний радиус",
       y = "Вероятность злокачественной опухоли")
```
Вывод: График показывает, что по мере увеличения среднего радиуса опухоли вероятность злокачественной опухоли также увеличивается. Это согласуется с результатами модели логистической регрессии, которая показала, что существует статистически значимая связь между средним радиусом опухоли и вероятностью злокачественной опухоли (p-значение < 0,05),  95% CI [3.04, 4.33] - не пересекает 0.


```{r}
# diagnosis~area_mean
model2 <- glm(diagnosis~area_mean, data = bc, family = binomial())

results2 <- report(model2)
print(results2)
# построение графика
ggplot(bc, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", se = FALSE, method.args = list(family=binomial)) +
  labs(title = "Вероятность злокачественной опухоли в зависимости от средней площади",
       x = "Средняя площадь",
       y = "Вероятность злокачественной опухоли")
```
Вывод: результаты логистической регрессии показывают, что средняя площадь опухоли является статистически значимым фактором для прогнозирования вероятности злокачественной опухоли, 95% CI [3.44, 4.95] не пересекает 0, p < .001 .



```{r}

# diagnosis~texture_mean
model3 <- glm(diagnosis~texture_mean, data = bc, family = binomial())

results3 <- report(model3)
print(results3)



# построение графика
ggplot(bc, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", se = FALSE, method.args = list(family=binomial)) +
  labs(title = "Вероятность злокачественной опухоли в зависимости от текстуры",
       x = "текстура",
       y = "Вероятность злокачественной опухоли")
```
Вывод: Существует статистически значимая связь между средним значением текстуры и вероятностью злокачественной опухоли (p-значение = <2e-16 < 0,05), 95% CI [0.80, 1.24] - не пересекает 0. Это означает, что среднее значение текстуры является важным фактором для прогнозирования вероятности злокачественной опухоли.


*Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.*

```{r}
# модель от 3х факторов
library(report)

model4 <- glm(diagnosis~texture_mean+area_mean+radius_mean, data = bc, family = binomial())
results <- report(model4)
print(results)
```
Вывод: 
- Влияние среднего значения текстуры статистически значимо и положительно (бета = 0,21, 95% ДИ [0,14, 0,28], p < 0,001; стандартное бета = 0,90, 95% ДИ [0,59, 1,22])
   - Влияние среднего значения площади является статистически незначимым и положительным (бета = 0,02, 95% ДИ [-4,55e-03, 0,04], p = 0,137; стандартное бета = 5,76, 95% ДИ [-1,60,
13.42])
   - Влияние среднего радиуса статистически незначимо и отрицательно (бета = -0,39, 95% ДИ [-2,22, 1,48], p = 0,687; стандартное бета = -1,36, 95% ДИ [-7,84, 5,22])


# Задание 3 (6 балла)
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?


```{r}
#.rs.restartR()

# install.packages("survival")    # установка пакета survival. Закомментила, тк он у меня уже установлен
library(survival) 

lung  # отображаю датасет.
```

*Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.*


```{r}
lung$event <- ifelse(lung$status == 2, 1, 0)

tail(lung)

```

*Изучите работу функций Surv(), survfit() и ggsurvplot(). Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.*

```{r}
# install.packages("survminer")  #установка пакета 
library(survminer)

# Создание модели выживаемости для каждого пола
fit <- survfit(Surv(lung$time, lung$event) ~ sex, data = lung)

# Построение кривых выживаемости
ggsurvplot(fit, data = lung, 
           xlab="время выживаемости в днях", 
           ylab="вероятность ОВ",
           pval = TRUE,
           risk.table=TRUE,
           conf.int=TRUE,
           surv.median.line="hv",
           risk.table.col = "strata")+
  ggtitle(" кривые выживаемости в зависимости от пола")

# лонгранговый тест

lonftest_result <- survdiff(Surv(lung$time, lung$event) ~ sex, data = lung)

lonftest_result

```
Для лонгрангового теста (который необходим для выявления статистически значимой разницы в выживаемости между группами) сформулируем 2 гипотезы:
H 0 : Нет никакой разницы в выживаемости между двумя группами.
H A : Существует разница в выживаемости между двумя группами.
В нашем случае получился результат p-value= 0.001, что меньше чем 0.05, а значит мы можем отклонить Н0, а значит, существует статистически значимая разница разница в выживаемости между двумя группами. Пол 2 (женщины) имеют лучшую выживаемость, чем мужчины. Вероятно, это связано с более внимательному отношению к своему здоровью.

*Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.*

```{r}
ggsurvplot(survfit(Surv(time, event=event) ~ sex, data=lung),
          conf.int = TRUE,
          ggtheme = theme_bw(), 
          fun = "cumhaz",
          risk.table = TRUE,
          pval = TRUE)+
  ggtitle(" график кумулятивной функции рисков (cumulative hazard function) для пола")
```

На графиках видно, что по мере увеличения времени в днях (примерно до 650 дней) кривые идут достаточно полого, что говорит о низких рисках смерти (тк мы анализируем риски смерти - переменная event), однако после 650 дней кривая резко идет вверх для женского пола, что говорит о бОльшем риске смерти, а для мужского пола сохраняется постепенный рост риска смерти. но, в целом, риск смерти для мужчин выше чем для женщин.

*С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?*

```{r}
cox_sex = coxph(Surv(time, event) ~ sex, data=lung)
print(cox_sex)
```
Выводы:
Пол в значительной степени влияет на выживаемость (значение p = 0,00149), при этом выживаемость женщин лучше, чем у мужчин (коэффициент риска смерти = 0,588).

Модель статистически значима. Это значение p модели 0,00111 действительно близко к значению p = 0,00131, которое мы видели лог-тесте, а Likelihood ratio тест = 10,63, что близко к логарифмическому хи-квадрату (10,3) в лог-тесте.

1/0,588 = 1,7, => мужчины умирают примерно в 1,7 раза чаще, чем женщины







